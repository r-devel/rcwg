[
    {
        "subtype": "bot_message",
        "text": "*[Bug 18961] New: Invalid HTML TOC generated by Rd2HTML causes failed package CHECK*\n<https:\/\/bugs.r-project.org\/show_bug.cgi?id=18961>\n\n            Bug ID: 18961\n           Summary: Invalid HTML TOC generated by Rd2HTML causes failed\n                    package CHECK\n           Product: R\n           Version: R 4.5.x\n          Hardware: All\n                OS: All\n            Status: UNCONFIRMED\n          Severity: normal\n          Priority: P5\n         Component: Misc\n          Assignee: <mailto:R-core@R-project.org|R-core@R-project.org>\n          Reporter: <mailto:mflick@umich.edu|mflick@umich.edu>\n\nThe problem was originally raised here:\n<https:\/\/stackoverflow.com\/questions\/79794990\/r-documentation-validation-problem-for-the-generated-html>\nand also seen here <https:\/\/github.com\/microsoft\/LightGBM\/issues\/7073>\n\nThe problem seems to be that when you use `Rd2HTML(..., toc=TRUE)`, under\ncertain circumstances,  the HTML produced is invalid which causes errors when\nusing `R CMD check --as-cran` because it runs the `tidy` utility to validate\nthe HTML output.\n\nSpecifically there seems to be a problem when the last element in the Rd is an\n\"argitem\" or \"subsection\" (which is meant to be \"nested\" in the TOC). The HTML\nproduced nests a &lt;ul&gt; tag in a &lt;ul&gt; tag which is not permitted. The nested &lt;ul&gt;\nneeds to be inside a &lt;li&gt;.\n\nA minimal reproducible example is\n```\nx &lt;- r\"(\\name{fun}\n\\title{Ttile}\n\\description{Description}\n\\usage{\nfun(x)\n}\n\\arguments{\n  \\item{x}{a value}\n})\"\nrd &lt;- tools::parse_Rd(conn &lt;- textConnection(x))\nclose(conn)\ntools::Rd2HTML(rd, toc=TRUE)\n```\nAnd if we look at just the nav section in the output, we see\n```\n&lt;nav class=\"topic\" aria-label=\"Section Navigation\"&gt;\n&lt;div class=\"dropdown-menu\"&gt;\n&lt;h1&gt;Contents&lt;\/h1&gt;\n&lt;ul class=\"menu\"&gt;\n  &lt;li&gt;&lt;a href='#_sec_description'&gt;&lt;p&gt;Description&lt;\/p&gt;&lt;\/a&gt;&lt;\/li&gt;\n  &lt;li&gt;&lt;a href='#_sec_usage'&gt;&lt;p&gt;Usage&lt;\/p&gt;&lt;\/a&gt;&lt;\/li&gt;\n  &lt;li&gt;&lt;a href='#_sec_arguments'&gt;&lt;p&gt;Arguments&lt;\/p&gt;&lt;\/a&gt;&lt;\/li&gt;\n  &lt;ul&gt;\n    &lt;li&gt;&lt;a href='#x'&gt;&lt;code&gt;x&lt;\/code&gt;&lt;\/a&gt;&lt;\/li&gt;\n  &lt;\/ul&gt;\n&lt;\/div&gt;\n&lt;\/nav&gt;\n```\nWhich has the &lt;ul&gt; with the wrong parent (and a missing &lt;\/ul&gt; tag)\n\nThe recent change to automatically build the TOC on package build will now make\nthis error more common (see\n<https:\/\/github.com\/wch\/r-source\/commit\/2022aa9cd39e7fa2bbea87c33a96c0282952b1c7>).\n\nHere's a possible fix with minimal changes to the `writeNav()` function inside\nof `Rd2HTML`\n\n```\nwriteNav &lt;- function() {\n\n  of0('&lt;nav class=\"topic\" aria-label=\"Section Navigation\"&gt;\\n',\n      '&lt;div class=\"dropdown-menu\"&gt;\\n',\n      if (dynamic) '&lt;img class=\"toplogo\" src=\"..\/logo\" alt=\"[logo]\"&gt;'\n      else sprintf('&lt;img class=\"toplogo\" src=\"%s\" alt=\"[logo]\"&gt;',\nstaticLogoPath(package, relative = TRUE)),\n      '&lt;h1&gt;Contents&lt;\/h1&gt;\\n',\n      '&lt;ul class=\"menu\"&gt;\\n')\n\n  currentLevel &lt;- 0L # entry_types = argitem, subsection are level 2\n  ## toc_entries &lt;- list( section|subsection|argitem = list(id, value) )\n  entry_types &lt;- names(toc_entries)\n  for (i in seq_along(toc_entries)) {\n    newLevel &lt;-\n      if (entry_types[[i]] %in% c(\"argitem\", \"subsection\")) 2L\n    else 1L\n    if (currentLevel == 0) {} # do nothing\n    else if (newLevel == currentLevel) of0(\"&lt;\/li&gt;\\n\")\n    else if (newLevel &gt; currentLevel) of0(\"&lt;ul&gt;\\n\")\n    else if (newLevel &lt; currentLevel) of1(\"&lt;\/li&gt;\\n&lt;\/ul&gt;\")\n    currentLevel &lt;- newLevel\n    e &lt;- toc_entries[[i]] # id, value can be vectors\n    of0(sprintf(\"&lt;li&gt;&lt;a href='#%s'&gt;%s&lt;\/a&gt;\", e$id, e$value))\n  }\n  if (currentLevel &gt; 1L) of0(\"&lt;\/li&gt;&lt;\/ul&gt;\\n\")\n  of0('&lt;\/ul&gt;\\n',\n      '&lt;\/div&gt;\\n',\n      '&lt;\/nav&gt;')\n}\n```",
        "username": "r-bugs notifier",
        "icons": {
            "emoji": ":robot_face:"
        },
        "type": "message",
        "ts": "1761673483.601889",
        "bot_id": "B06769YJX9Q",
        "app_id": "A024R9PQM",
        "blocks": [
            {
                "type": "rich_text",
                "block_id": "L+iN",
                "elements": [
                    {
                        "type": "rich_text_section",
                        "elements": [
                            {
                                "type": "text",
                                "text": "[Bug 18961] New: Invalid HTML TOC generated by Rd2HTML causes failed package CHECK",
                                "style": {
                                    "bold": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "\n"
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/bugs.r-project.org\/show_bug.cgi?id=18961"
                            },
                            {
                                "type": "text",
                                "text": "\n\n            Bug ID: 18961\n           Summary: Invalid HTML TOC generated by Rd2HTML causes failed\n                    package CHECK\n           Product: R\n           Version: R 4.5.x\n          Hardware: All\n                OS: All\n            Status: UNCONFIRMED\n          Severity: normal\n          Priority: P5\n         Component: Misc\n          Assignee: "
                            },
                            {
                                "type": "link",
                                "url": "mailto:R-core@R-project.org",
                                "text": "R-core@R-project.org",
                                "unsafe": true
                            },
                            {
                                "type": "text",
                                "text": "\n          Reporter: "
                            },
                            {
                                "type": "link",
                                "url": "mailto:mflick@umich.edu",
                                "text": "mflick@umich.edu"
                            },
                            {
                                "type": "text",
                                "text": "\n\nThe problem was originally raised here:\n"
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/stackoverflow.com\/questions\/79794990\/r-documentation-validation-problem-for-the-generated-html"
                            },
                            {
                                "type": "text",
                                "text": "\nand also seen here "
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/github.com\/microsoft\/LightGBM\/issues\/7073"
                            },
                            {
                                "type": "text",
                                "text": "\n\nThe problem seems to be that when you use "
                            },
                            {
                                "type": "text",
                                "text": "Rd2HTML(..., toc=TRUE)",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": ", under\ncertain circumstances,  the HTML produced is invalid which causes errors when\nusing "
                            },
                            {
                                "type": "text",
                                "text": "R CMD check --as-cran",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " because it runs the "
                            },
                            {
                                "type": "text",
                                "text": "tidy",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " utility to validate\nthe HTML output.\n\nSpecifically there seems to be a problem when the last element in the Rd is an\n\"argitem\" or \"subsection\" (which is meant to be \"nested\" in the TOC). The HTML\nproduced nests a <ul> tag in a <ul> tag which is not permitted. The nested <ul>\nneeds to be inside a <li>.\n\nA minimal reproducible example is"
                            }
                        ]
                    },
                    {
                        "type": "rich_text_preformatted",
                        "elements": [
                            {
                                "type": "text",
                                "text": "x <- r\"(\\name{fun}\n\\title{Ttile}\n\\description{Description}\n\\usage{\nfun(x)\n}\n\\arguments{\n  \\item{x}{a value}\n})\"\nrd <- tools::parse_Rd(conn <- textConnection(x))\nclose(conn)\ntools::Rd2HTML(rd, toc=TRUE)\n"
                            }
                        ]
                    },
                    {
                        "type": "rich_text_section",
                        "elements": [
                            {
                                "type": "text",
                                "text": "And if we look at just the nav section in the output, we see"
                            }
                        ]
                    },
                    {
                        "type": "rich_text_preformatted",
                        "elements": [
                            {
                                "type": "text",
                                "text": "<nav class=\"topic\" aria-label=\"Section Navigation\">\n<div class=\"dropdown-menu\">\n<h1>Contents<\/h1>\n<ul class=\"menu\">\n  <li><a href='#_sec_description'><p>Description<\/p><\/a><\/li>\n  <li><a href='#_sec_usage'><p>Usage<\/p><\/a><\/li>\n  <li><a href='#_sec_arguments'><p>Arguments<\/p><\/a><\/li>\n  <ul>\n    <li><a href='#x'><code>x<\/code><\/a><\/li>\n  <\/ul>\n<\/div>\n<\/nav>\n"
                            }
                        ]
                    },
                    {
                        "type": "rich_text_section",
                        "elements": [
                            {
                                "type": "text",
                                "text": "Which has the <ul> with the wrong parent (and a missing <\/ul> tag)\n\nThe recent change to automatically build the TOC on package build will now make\nthis error more common (see\n"
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/github.com\/wch\/r-source\/commit\/2022aa9cd39e7fa2bbea87c33a96c0282952b1c7"
                            },
                            {
                                "type": "text",
                                "text": ").\n\nHere's a possible fix with minimal changes to the "
                            },
                            {
                                "type": "text",
                                "text": "writeNav()",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " function inside\nof "
                            },
                            {
                                "type": "text",
                                "text": "Rd2HTML",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "\n\n"
                            }
                        ]
                    },
                    {
                        "type": "rich_text_preformatted",
                        "elements": [
                            {
                                "type": "text",
                                "text": "writeNav <- function() {\n\n  of0('<nav class=\"topic\" aria-label=\"Section Navigation\">\\n',\n      '<div class=\"dropdown-menu\">\\n',\n      if (dynamic) '<img class=\"toplogo\" src=\"..\/logo\" alt=\"[logo]\">'\n      else sprintf('<img class=\"toplogo\" src=\"%s\" alt=\"[logo]\">',\nstaticLogoPath(package, relative = TRUE)),\n      '<h1>Contents<\/h1>\\n',\n      '<ul class=\"menu\">\\n')\n\n  currentLevel <- 0L # entry_types = argitem, subsection are level 2\n  ## toc_entries <- list( section|subsection|argitem = list(id, value) )\n  entry_types <- names(toc_entries)\n  for (i in seq_along(toc_entries)) {\n    newLevel <-\n      if (entry_types[[i]] %in% c(\"argitem\", \"subsection\")) 2L\n    else 1L\n    if (currentLevel == 0) {} # do nothing\n    else if (newLevel == currentLevel) of0(\"<\/li>\\n\")\n    else if (newLevel > currentLevel) of0(\"<ul>\\n\")\n    else if (newLevel < currentLevel) of1(\"<\/li>\\n<\/ul>\")\n    currentLevel <- newLevel\n    e <- toc_entries[[i]] # id, value can be vectors\n    of0(sprintf(\"<li><a href='#%s'>%s<\/a>\", e$id, e$value))\n  }\n  if (currentLevel > 1L) of0(\"<\/li><\/ul>\\n\")\n  of0('<\/ul>\\n',\n      '<\/div>\\n',\n      '<\/nav>')\n}\n"
                            }
                        ]
                    }
                ]
            }
        ]
    },
    {
        "subtype": "bot_message",
        "text": "*[Bug 18955] cairo library update 1.16 -&gt; 1.18 seems to break font embedding into PDF (R 4.3 -&gt; 4.4 transition)*\n<https:\/\/bugs.r-project.org\/show_bug.cgi?id=18955>\n\nSimon Urbanek (<mailto:simon.urbanek@r-project.org|simon.urbanek@r-project.org>) changed:\n\n           What    |Removed                     |Added\n----------------------------------------------------------------------------\n         Resolution|---                         |FIXED\n             Status|CONFIRMED                   |CLOSED\n\n--- Comment #19 from Simon Urbanek (<mailto:simon.urbanek@r-project.org|simon.urbanek@r-project.org>) ---\nI can confirm that this fixes it (r88967 + r88973 in R-devel). For\n[Cairo](<https:\/\/rforge.net\/Cairo>) the corresponding issue was tracked as [Cairo\n#50](<https:\/\/github.com\/s-u\/Cairo\/issues\/50>) and is now also fixed with a\nsimilar approach.",
        "username": "r-bugs notifier",
        "icons": {
            "emoji": ":robot_face:"
        },
        "type": "message",
        "ts": "1761714838.675919",
        "bot_id": "B06769YJX9Q",
        "app_id": "A024R9PQM",
        "blocks": [
            {
                "type": "rich_text",
                "block_id": "8xM",
                "elements": [
                    {
                        "type": "rich_text_section",
                        "elements": [
                            {
                                "type": "text",
                                "text": "[Bug 18955] cairo library update 1.16 -> 1.18 seems to break font embedding into PDF (R 4.3 -> 4.4 transition)",
                                "style": {
                                    "bold": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "\n"
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/bugs.r-project.org\/show_bug.cgi?id=18955"
                            },
                            {
                                "type": "text",
                                "text": "\n\nSimon Urbanek ("
                            },
                            {
                                "type": "link",
                                "url": "mailto:simon.urbanek@r-project.org",
                                "text": "simon.urbanek@r-project.org",
                                "unsafe": true
                            },
                            {
                                "type": "text",
                                "text": ") changed:\n\n           What    |Removed                     |Added\n----------------------------------------------------------------------------\n         Resolution|---                         |FIXED\n             Status|CONFIRMED                   |CLOSED\n\n--- Comment #19 from Simon Urbanek ("
                            },
                            {
                                "type": "link",
                                "url": "mailto:simon.urbanek@r-project.org",
                                "text": "simon.urbanek@r-project.org",
                                "unsafe": true
                            },
                            {
                                "type": "text",
                                "text": ") ---\nI can confirm that this fixes it (r88967 + r88973 in R-devel). For\n[Cairo]("
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/rforge.net\/Cairo"
                            },
                            {
                                "type": "text",
                                "text": ") the corresponding issue was tracked as [Cairo\n#50]("
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/github.com\/s-u\/Cairo\/issues\/50"
                            },
                            {
                                "type": "text",
                                "text": ") and is now also fixed with a\nsimilar approach."
                            }
                        ]
                    }
                ]
            }
        ]
    }
]