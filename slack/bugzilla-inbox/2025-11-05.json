[
    {
        "subtype": "bot_message",
        "text": "*[Bug 18963] New: Allow packages to provide serialization hooks for R objects*\n<https:\/\/bugs.r-project.org\/show_bug.cgi?id=18963>\n\n            Bug ID: 18963\n           Summary: Allow packages to provide serialization hooks for R\n                    objects\n           Product: R\n           Version: R-devel (trunk)\n          Hardware: Other\n                OS: Other\n            Status: UNCONFIRMED\n          Severity: enhancement\n          Priority: P5\n         Component: Wishlist\n          Assignee: <mailto:R-core@R-project.org|R-core@R-project.org>\n          Reporter: <mailto:kevinushey@gmail.com|kevinushey@gmail.com>\n\nIt can be challenging to correctly save and restore an R workspace with objects\ncontaining things like external pointers, as such values will be 'null'\nfollowing the restore. There are some tools made available in R to help support\nthis, e.g. the `refhook` argument in `saveRDS()` \/ `readRDS()`, but:\n\n- It needs to be explicitly specified by the user during save and load;\n- There's no way to use it in other interfaces for saving objects like `save()`\nor `save.image()`.\n\nIt would be useful if R provided an alternate interface here. One proposal\nwould draw upon some existing usages. For example, the `terra` package creates\ngeneric functions for `saveRDS` and `readRDS`, and defines its own methods\nwhich \"wrap\" and \"unwrap\" objects at save and load time. For example:\n\n```\n&gt; getMethod(\"saveRDS\", \"SpatRaster\")\nMethod Definition:\n\nfunction (object, file = \"\", ascii = FALSE, version = NULL, compress = TRUE, \n    refhook = NULL) \n{\n    object &lt;- wrap(object)\n    saveRDS(object, file = file, ascii = ascii, version = version, \n        compress = compress, refhook = refhook)\n}\n&lt;bytecode: 0xb04f963f8&gt;\n&lt;environment: namespace:terra&gt;\n```\n\nPerhaps a similar interface could become part of R, with packages defining\nmethods for 'save' hooks and 'load' hooks which could be used to transform\nobjects appropriately at save \/ load time?",
        "username": "r-bugs notifier",
        "icons": {
            "emoji": ":robot_face:"
        },
        "type": "message",
        "ts": "1762366827.563049",
        "bot_id": "B06769YJX9Q",
        "app_id": "A024R9PQM",
        "blocks": [
            {
                "type": "rich_text",
                "block_id": "A+a",
                "elements": [
                    {
                        "type": "rich_text_section",
                        "elements": [
                            {
                                "type": "text",
                                "text": "[Bug 18963] New: Allow packages to provide serialization hooks for R objects",
                                "style": {
                                    "bold": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "\n"
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/bugs.r-project.org\/show_bug.cgi?id=18963"
                            },
                            {
                                "type": "text",
                                "text": "\n\n            Bug ID: 18963\n           Summary: Allow packages to provide serialization hooks for R\n                    objects\n           Product: R\n           Version: R-devel (trunk)\n          Hardware: Other\n                OS: Other\n            Status: UNCONFIRMED\n          Severity: enhancement\n          Priority: P5\n         Component: Wishlist\n          Assignee: "
                            },
                            {
                                "type": "link",
                                "url": "mailto:R-core@R-project.org",
                                "text": "R-core@R-project.org",
                                "unsafe": true
                            },
                            {
                                "type": "text",
                                "text": "\n          Reporter: "
                            },
                            {
                                "type": "link",
                                "url": "mailto:kevinushey@gmail.com",
                                "text": "kevinushey@gmail.com"
                            },
                            {
                                "type": "text",
                                "text": "\n\nIt can be challenging to correctly save and restore an R workspace with objects\ncontaining things like external pointers, as such values will be 'null'\nfollowing the restore. There are some tools made available in R to help support\nthis, e.g. the "
                            },
                            {
                                "type": "text",
                                "text": "refhook",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " argument in "
                            },
                            {
                                "type": "text",
                                "text": "saveRDS()",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " \/ "
                            },
                            {
                                "type": "text",
                                "text": "readRDS()",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": ", but:\n\n- It needs to be explicitly specified by the user during save and load;\n- There's no way to use it in other interfaces for saving objects like "
                            },
                            {
                                "type": "text",
                                "text": "save()",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "\nor "
                            },
                            {
                                "type": "text",
                                "text": "save.image()",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": ".\n\nIt would be useful if R provided an alternate interface here. One proposal\nwould draw upon some existing usages. For example, the "
                            },
                            {
                                "type": "text",
                                "text": "terra",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " package creates\ngeneric functions for "
                            },
                            {
                                "type": "text",
                                "text": "saveRDS",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " and "
                            },
                            {
                                "type": "text",
                                "text": "readRDS",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": ", and defines its own methods\nwhich \"wrap\" and \"unwrap\" objects at save and load time. For example:\n\n"
                            }
                        ]
                    },
                    {
                        "type": "rich_text_preformatted",
                        "elements": [
                            {
                                "type": "text",
                                "text": "> getMethod(\"saveRDS\", \"SpatRaster\")\nMethod Definition:\n\nfunction (object, file = \"\", ascii = FALSE, version = NULL, compress = TRUE, \n    refhook = NULL) \n{\n    object <- wrap(object)\n    saveRDS(object, file = file, ascii = ascii, version = version, \n        compress = compress, refhook = refhook)\n}\n<bytecode: 0xb04f963f8>\n<environment: namespace:terra>\n"
                            }
                        ]
                    },
                    {
                        "type": "rich_text_section",
                        "elements": [
                            {
                                "type": "text",
                                "text": "\n\nPerhaps a similar interface could become part of R, with packages defining\nmethods for 'save' hooks and 'load' hooks which could be used to transform\nobjects appropriately at save \/ load time?"
                            }
                        ]
                    }
                ]
            }
        ]
    },
    {
        "subtype": "bot_message",
        "text": "*[Bug 18963] Allow packages to provide serialization hooks for R objects*\n<https:\/\/bugs.r-project.org\/show_bug.cgi?id=18963>\n\n--- Comment #1 from Kevin Ushey (<mailto:kevinushey@gmail.com|kevinushey@gmail.com>) ---\nTo give a more concrete suggestion, R could provide a pair of generics, e.g.\n(borrowing the nomenclature used by `terra`; but alternate names could be more\nappropriate)\n\n```\nwrap &lt;- function(object) { UseMethod(\"wrap\") }\nwrap.default &lt;- function(object) object\n\nunwrap &lt;- function(object) { UseMethod(\"unwrap\") }\nunwrap.default &lt;- function(object) object\n```\n\nand call those at appropriate points when serializing or unserializing an\nobject.",
        "username": "r-bugs notifier",
        "icons": {
            "emoji": ":robot_face:"
        },
        "type": "message",
        "ts": "1762367127.570829",
        "bot_id": "B06769YJX9Q",
        "app_id": "A024R9PQM",
        "blocks": [
            {
                "type": "rich_text",
                "block_id": "3\/RZ",
                "elements": [
                    {
                        "type": "rich_text_section",
                        "elements": [
                            {
                                "type": "text",
                                "text": "[Bug 18963] Allow packages to provide serialization hooks for R objects",
                                "style": {
                                    "bold": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "\n"
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/bugs.r-project.org\/show_bug.cgi?id=18963"
                            },
                            {
                                "type": "text",
                                "text": "\n\n--- Comment #1 from Kevin Ushey ("
                            },
                            {
                                "type": "link",
                                "url": "mailto:kevinushey@gmail.com",
                                "text": "kevinushey@gmail.com"
                            },
                            {
                                "type": "text",
                                "text": ") ---\nTo give a more concrete suggestion, R could provide a pair of generics, e.g.\n(borrowing the nomenclature used by "
                            },
                            {
                                "type": "text",
                                "text": "terra",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "; but alternate names could be more\nappropriate)\n\n"
                            }
                        ]
                    },
                    {
                        "type": "rich_text_preformatted",
                        "elements": [
                            {
                                "type": "text",
                                "text": "wrap <- function(object) { UseMethod(\"wrap\") }\nwrap.default <- function(object) object\n\nunwrap <- function(object) { UseMethod(\"unwrap\") }\nunwrap.default <- function(object) object\n"
                            }
                        ]
                    },
                    {
                        "type": "rich_text_section",
                        "elements": [
                            {
                                "type": "text",
                                "text": "\n\nand call those at appropriate points when serializing or unserializing an\nobject."
                            }
                        ]
                    }
                ]
            }
        ]
    },
    {
        "subtype": "bot_message",
        "text": "*[Bug 18963] Allow packages to provide serialization hooks for R objects*\n<https:\/\/bugs.r-project.org\/show_bug.cgi?id=18963>\n\nLuke Tierney (<mailto:luke@stat.uiowa.edu|luke@stat.uiowa.edu>) changed:\n\n           What    |Removed                     |Added\n----------------------------------------------------------------------------\n             Status|UNCONFIRMED                 |CONFIRMED\n     Ever confirmed|0                           |1\n                 CC|                            |luke@stat.uiowa.edu\n\n--- Comment #2 from Luke Tierney (<mailto:luke@stat.uiowa.edu|luke@stat.uiowa.edu>) ---\n(In reply to Kevin Ushey from comment #1)\nI can see the value of something like this, but it would be challenging to\ndesign. The fundamental problem is that at the point where an object with an S3\nclass is unserialized there is no information available about what package(s)\nneed to be loaded to provide the `unwrap` method. There would have to be some\nconvention about adding such information at the `wrap` stage for this to work.\n\nI also am less than enthusiastic about adding more complexity to the\nserialization code, which is already one of the more challenging bits of R to\nmaintain. And adding more automatic code execution to unserialize is the kind\nof thing that unfortunately gets various security \"experts\" all hot and\nbothered, and when that happens a lot of us end up wasting a lot of time ...\n\nI usually handle this sort of thing by including an external pointer in the\nobject. When those are unserialized the pointer value is `NULL`, so a function\nusing the object can check if the object went through a `serialize\/unserialize`\ncycle and needs to be reconstituted in some way. Not suitable for all\nsituations, but it is an option that is available now.",
        "username": "r-bugs notifier",
        "icons": {
            "emoji": ":robot_face:"
        },
        "type": "message",
        "ts": "1762375124.587149",
        "bot_id": "B06769YJX9Q",
        "app_id": "A024R9PQM",
        "blocks": [
            {
                "type": "rich_text",
                "block_id": "nxT",
                "elements": [
                    {
                        "type": "rich_text_section",
                        "elements": [
                            {
                                "type": "text",
                                "text": "[Bug 18963] Allow packages to provide serialization hooks for R objects",
                                "style": {
                                    "bold": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "\n"
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/bugs.r-project.org\/show_bug.cgi?id=18963"
                            },
                            {
                                "type": "text",
                                "text": "\n\nLuke Tierney ("
                            },
                            {
                                "type": "link",
                                "url": "mailto:luke@stat.uiowa.edu",
                                "text": "luke@stat.uiowa.edu",
                                "unsafe": true
                            },
                            {
                                "type": "text",
                                "text": ") changed:\n\n           What    |Removed                     |Added\n----------------------------------------------------------------------------\n             Status|UNCONFIRMED                 |CONFIRMED\n     Ever confirmed|0                           |1\n                 CC|                            |luke@stat.uiowa.edu\n\n--- Comment #2 from Luke Tierney ("
                            },
                            {
                                "type": "link",
                                "url": "mailto:luke@stat.uiowa.edu",
                                "text": "luke@stat.uiowa.edu",
                                "unsafe": true
                            },
                            {
                                "type": "text",
                                "text": ") ---\n(In reply to Kevin Ushey from comment #1)\nI can see the value of something like this, but it would be challenging to\ndesign. The fundamental problem is that at the point where an object with an S3\nclass is unserialized there is no information available about what package(s)\nneed to be loaded to provide the "
                            },
                            {
                                "type": "text",
                                "text": "unwrap",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " method. There would have to be some\nconvention about adding such information at the "
                            },
                            {
                                "type": "text",
                                "text": "wrap",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " stage for this to work.\n\nI also am less than enthusiastic about adding more complexity to the\nserialization code, which is already one of the more challenging bits of R to\nmaintain. And adding more automatic code execution to unserialize is the kind\nof thing that unfortunately gets various security \"experts\" all hot and\nbothered, and when that happens a lot of us end up wasting a lot of time ...\n\nI usually handle this sort of thing by including an external pointer in the\nobject. When those are unserialized the pointer value is "
                            },
                            {
                                "type": "text",
                                "text": "NULL",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": ", so a function\nusing the object can check if the object went through a "
                            },
                            {
                                "type": "text",
                                "text": "serialize\/unserialize",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "\ncycle and needs to be reconstituted in some way. Not suitable for all\nsituations, but it is an option that is available now."
                            }
                        ]
                    }
                ]
            }
        ]
    },
    {
        "subtype": "bot_message",
        "text": "*[Bug 18963] Allow packages to provide serialization hooks for R objects*\n<https:\/\/bugs.r-project.org\/show_bug.cgi?id=18963>\n\nSimon Urbanek (<mailto:simon.urbanek@r-project.org|simon.urbanek@r-project.org>) changed:\n\n           What    |Removed                     |Added\n----------------------------------------------------------------------------\n                 CC|                            |simon.urbanek@r-project.org\n\n--- Comment #3 from Simon Urbanek (<mailto:simon.urbanek@r-project.org|simon.urbanek@r-project.org>) ---\nI don't think the proposed solution would help much, because it is strictly\nlimited to explicit serialization of a single object with `saveRDS`, so not\nreally an interesting case as you could simply provide your own method for that\ninstead - and not addressing the original issue of hitting any other\nserialization points.\n\nHowever, I agree with Luke and I think `EXTPTR`s are the correct method to\nimplement it as that is presumably the only real use-case here. Any code that\nuses the `EXTPTR` can simply inspect `PTR` on use and reconstruct (see rJava\nfor example - it uses `PROT` to store the serialized version and restores it if\n`PTR` is `NULL` at access time).\n\nThe only piece missing is the tagging of the `EXTPTR` before the serialization\nto make sure the information is up-to-date in cases where the external object\nis mutable outside of R. I suppose some mechanism by which the `EXTPTR` object\ncould ask for a function\/method to be called just before it gets serialized\nwould do it. It circumvents the unserialization problem since at access time\nthe package is loaded.",
        "username": "r-bugs notifier",
        "icons": {
            "emoji": ":robot_face:"
        },
        "type": "message",
        "ts": "1762379383.716229",
        "bot_id": "B06769YJX9Q",
        "app_id": "A024R9PQM",
        "blocks": [
            {
                "type": "rich_text",
                "block_id": "HUv",
                "elements": [
                    {
                        "type": "rich_text_section",
                        "elements": [
                            {
                                "type": "text",
                                "text": "[Bug 18963] Allow packages to provide serialization hooks for R objects",
                                "style": {
                                    "bold": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "\n"
                            },
                            {
                                "type": "link",
                                "url": "https:\/\/bugs.r-project.org\/show_bug.cgi?id=18963"
                            },
                            {
                                "type": "text",
                                "text": "\n\nSimon Urbanek ("
                            },
                            {
                                "type": "link",
                                "url": "mailto:simon.urbanek@r-project.org",
                                "text": "simon.urbanek@r-project.org",
                                "unsafe": true
                            },
                            {
                                "type": "text",
                                "text": ") changed:\n\n           What    |Removed                     |Added\n----------------------------------------------------------------------------\n                 CC|                            |simon.urbanek@r-project.org\n\n--- Comment #3 from Simon Urbanek ("
                            },
                            {
                                "type": "link",
                                "url": "mailto:simon.urbanek@r-project.org",
                                "text": "simon.urbanek@r-project.org",
                                "unsafe": true
                            },
                            {
                                "type": "text",
                                "text": ") ---\nI don't think the proposed solution would help much, because it is strictly\nlimited to explicit serialization of a single object with "
                            },
                            {
                                "type": "text",
                                "text": "saveRDS",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": ", so not\nreally an interesting case as you could simply provide your own method for that\ninstead - and not addressing the original issue of hitting any other\nserialization points.\n\nHowever, I agree with Luke and I think "
                            },
                            {
                                "type": "text",
                                "text": "EXTPTR",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": "s are the correct method to\nimplement it as that is presumably the only real use-case here. Any code that\nuses the "
                            },
                            {
                                "type": "text",
                                "text": "EXTPTR",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " can simply inspect "
                            },
                            {
                                "type": "text",
                                "text": "PTR",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " on use and reconstruct (see rJava\nfor example - it uses "
                            },
                            {
                                "type": "text",
                                "text": "PROT",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " to store the serialized version and restores it if\n"
                            },
                            {
                                "type": "text",
                                "text": "PTR",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " is "
                            },
                            {
                                "type": "text",
                                "text": "NULL",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " at access time).\n\nThe only piece missing is the tagging of the "
                            },
                            {
                                "type": "text",
                                "text": "EXTPTR",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " before the serialization\nto make sure the information is up-to-date in cases where the external object\nis mutable outside of R. I suppose some mechanism by which the "
                            },
                            {
                                "type": "text",
                                "text": "EXTPTR",
                                "style": {
                                    "code": true
                                }
                            },
                            {
                                "type": "text",
                                "text": " object\ncould ask for a function\/method to be called just before it gets serialized\nwould do it. It circumvents the unserialization problem since at access time\nthe package is loaded."
                            }
                        ]
                    }
                ]
            }
        ]
    }
]